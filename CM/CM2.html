<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Romuald THION">
  <title>Développement Web</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4/dist/reset.css">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4/dist/theme/solarized.css" id="theme">
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section id="title-slide">
  <h1 class="title">Développement Web</h1>
  <p class="subtitle">La programmation asynchrone en JavaScript</p>
</section>

<section class="slide level3">

<!-- markdownlint-disable MD033 MD001 MD045 MD041 -->
</section>
<section>
<section id="fonctions-asynchrones-et-callbacks" class="title-slide slide level2">
<h2>Fonctions asynchrones et <em>callbacks</em></h2>
<p>Programmation <strong>événementielle</strong> <span class="math inline">\(\approxeq\)</span> <strong>asynchrone</strong></p>
<p><img data-src="img/async_javascript.jpeg" /></p>
</section>
<section id="la-boucle-dévénéments" class="slide level3">
<h3>La boucle d’événéments</h3>
<p><img data-src="img/event_loop.webp" alt="Boucle d’événéments" /> Source : <a href="https://dev.to/lydiahallie/javascript-visualized-event-loop-3dif">JavaScript Visualized: Event Loop</a></p>
<aside class="notes">
<p>Vieille illustration <img data-src="img/event_loop.jpg" alt="Boucle d’événéments client" /></p>
<p>Voir :</p>
<ul>
<li><a href="https://medium.com/gradeup/asynchronous-javascript-event-loop-1c8de41298dd" class="uri">https://medium.com/gradeup/asynchronous-javascript-event-loop-1c8de41298dd</a></li>
<li><a href="https://dev.to/lydiahallie/series/3341" class="uri">https://dev.to/lydiahallie/series/3341</a></li>
<li><a href="https://dev.to/lydiahallie/javascript-visualized-event-loop-3dif" class="uri">https://dev.to/lydiahallie/javascript-visualized-event-loop-3dif</a></li>
</ul>
</aside>
</section>
<section class="slide level3">

<h4 id="exemple-les-handlers-onevent">Exemple : les handlers <code>onevent</code></h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> $output <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&quot;output&quot;</span>)<span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> $input <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&quot;input&quot;</span>)<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> $eval <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&quot;eval&quot;</span>)<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">work</span>() {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  $output<span class="op">.</span><span class="at">innerHTML</span> <span class="op">+=</span> <span class="vs">`</span><span class="sc">${</span>$input<span class="op">.</span><span class="at">value</span> <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="vs">&lt;br/&gt;`</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>$eval<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> work)<span class="op">;</span></span></code></pre></div>
<p>Voir <a href="CM2_exemples/handler-button.html">l’exemple</a>.</p>
</section>
<section class="slide level3">

<h4 id="exemple-les-alarmes">Exemple : les alarmes</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Start&quot;</span>)<span class="op">;</span> <span class="co">// (A)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="pp">setTimeout</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// (T1)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Call back #1&quot;</span>)<span class="op">,</span> <span class="co">// (CB1)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Middle&quot;</span>)<span class="op">;</span> <span class="co">// (B)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="pp">setTimeout</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// (T2)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Call back #2&quot;</span>)<span class="op">,</span> <span class="co">// (CB2)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;End&quot;</span>)<span class="op">;</span> <span class="co">// (C)</span></span></code></pre></div>
<p><strong>NB</strong> : <code>setTimeout(fct, 0)</code> rend <code>fct</code> async.</p>
<p>Qu-est-ce qui s’affiche dans la console ? (<a href="CM2_exemples/async-two-timers.js">exemple</a>)</p>
</section>
<section class="slide level3">

<h4 id="attention-au-code-bloquant">Attention au code bloquant</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> s <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">getSeconds</span>()<span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">setTimeout</span>(<span class="kw">function</span> () {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Ran after &quot;</span> <span class="op">+</span> (<span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">getSeconds</span>() <span class="op">-</span> s) <span class="op">+</span> <span class="st">&quot; seconds&quot;</span>)<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">getSeconds</span>() <span class="op">-</span> s <span class="op">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Good, looped for 2 seconds&quot;</span>)<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Qu-est-ce qui s’affiche dans la console ? (<a href="CM2_exemples/async-event-blocking.js">exemple</a>)</p>
</section>
<section class="slide level3">

</section></section>
<section>
<section id="fonctions-asynchrones" class="title-slide slide level2">
<h2>Fonctions asynchrones</h2>
<ul>
<li>les fonctions <em>synchrones</em> sont <em>bloquantes</em>
<ul>
<li>le thread d’exécution <strong>attend</strong> la fin du traitement</li>
</ul></li>
<li>les fonctions <em>asynchrones</em> ne sont <em>pas bloquantes</em>
<ul>
<li>l’exécution <strong>continue</strong> après l’appel</li>
<li>on doit passer en paramètre la suite du traitement qui sera déclenchée <em>ultérieurement</em>
<ul>
<li>via le handler d’un <em>événement</em></li>
<li>via une paramètre appellé <em>callback</em></li>
</ul></li>
</ul></li>
</ul>
<p>Voir documentations sur <a href="https://javascript.info/callbacks">javascript.info</a>, <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Introducing">MDN</a> ou <a href="https://nodejs.org/en/docs/guides/blocking-vs-non-blocking/">Node.js</a></p>
</section>
<section id="lomniprésence-des-fonctions-asynchrones-en-javascript" class="slide level3">
<h3>L’omniprésence des fonctions asynchrones en JavaScript</h3>
<ul>
<li>Les gestionnaires d’événements pour <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Event_handlers">HTMLElement, Document, ou Window</a> et la programmation événementielle plus généralement.</li>
<li>Les applications AJAX (Asynchronous JavaScript + XML) <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">Fetch API</a> (et son ancêtre <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">XHR - XMLHttpRequest</a>)</li>
<li>L’essentiel de la bibliothèque standard Node.js comme <a href="https://nodejs.org/api/fs.html">FS - File System</a>, <a href="https://nodejs.org/api/http.html">HTTP</a> ou <a href="https://nodejs.org/api/stream.html">l’API stream</a></li>
</ul>
</section>
<section class="slide level3">

</section></section>
<section>
<section id="comment-rendre-une-fonction-work-asynchrone" class="title-slide slide level2">
<h2>Comment rendre une fonction <code>work</code> asynchrone ?</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// le traitement sychrone à rendre</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">work</span>(x) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">info</span>(<span class="vs">`work(</span><span class="sc">${</span>x<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">**</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>en la déclanchant avec <code>setTimeout(fct, 0)</code>
<ul>
<li><em>0 ms</em> = prochain tour de boucle d’événements</li>
</ul></li>
<li>comment lui passer des paramètres ?
<ul>
<li><code>fct</code> <strong>doit être une fonction</strong>, pas une valeur</li>
<li>le navigateur va appeller <code>fct()</code></li>
</ul></li>
</ul>
<div class="fragment">
<p>Ce n’est <strong>pas</strong> la meilleure façon de rendre une fonction asynchrone.</p>
</div>
</section>
<section id="exemple-dutilisation" class="slide level3">
<h3>Exemple d’utilisation</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// KO: pas de paramètre</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="pp">setTimeout</span>(work<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">// KO: typeof(work(2)) == &quot;number&quot;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="pp">setTimeout</span>(<span class="fu">work</span>(<span class="dv">2</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">// OK! avec function explicite</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="pp">setTimeout</span>(<span class="kw">function</span> () {</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">work</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">// OK! avec fat arrow</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="fu">work</span>(<span class="dv">2</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span></code></pre></div>
<p>Mais comment récupérer <strong>la valeur de retour</strong> de l’appel à <code>work(n)</code> ?</p>
</section>
<section id="tentative-1-avec-return" class="slide level3">
<h3>Tentative 1 : avec <code>return</code></h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">work</span>(x) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">info</span>(<span class="vs">`work(</span><span class="sc">${</span>x<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">**</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">async_work</span>(n) {</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="fu">work</span>(n)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> r1 <span class="op">=</span> <span class="fu">async_work</span>(<span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(r1)<span class="op">;</span></span></code></pre></div>
<p>Qu-est-ce qui s’affiche dans la console ? (<a href="CM2_exemples/async-return-1-no-cb.js">exemple</a>)</p>
</section>
<section id="tentative-2-avec-callback" class="slide level3">
<h3>Tentative 2 : avec callback</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">work</span>(x<span class="op">,</span> cb) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">info</span>(<span class="vs">`work(</span><span class="sc">${</span>x<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cb</span>(x <span class="op">**</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">info</span>(<span class="vs">`work done`</span>)<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">async_work</span>(n<span class="op">,</span> cb) {</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="fu">work</span>(n<span class="op">,</span> cb)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> r1 <span class="op">=</span> <span class="fu">async_work</span>(<span class="dv">3</span><span class="op">,</span> (r) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(r))<span class="op">;</span></span></code></pre></div>
<p>Qu-est-ce qui s’affiche dans la console ? (<a href="CM2_exemples/async-return-2-cb.js">exemple</a>)</p>
</section>
<section id="tentative-3-enchainer-les-traitements" class="slide level3">
<h3>Tentative 3 : enchainer les traitements</h3>
<p>Phénomène appellé <em>pyramid of doom</em> ou <em>callback hell</em></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">async_work</span>(n<span class="op">,</span> cb) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="fu">cb</span>(n <span class="op">**</span> <span class="dv">2</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">async_work</span>(<span class="dv">3</span><span class="op">,</span> (r1) <span class="kw">=&gt;</span> {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(r1)<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">async_work</span>(r1<span class="op">,</span> (r2) <span class="kw">=&gt;</span> {</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(r2)<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">async_work</span>(r2<span class="op">,</span> (r3) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(r3))<span class="op">;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Qu-est-ce qui s’affiche dans la console ? (<a href="CM2_exemples/async-return-3-cb-chain.js">exemple</a>)</p>
</section>
<section id="conventions-des-callbacks-node.js" class="slide level3">
<h3>Conventions des callbacks Node.js</h3>
<p><a href="https://nodejs.org/en/knowledge/errors/what-are-the-error-conventions/" class="uri">https://nodejs.org/en/knowledge/errors/what-are-the-error-conventions/</a></p>
<blockquote>
<p>So to wrap it all up, when using callbacks, if an error comes up, then pass it as the first argument. Otherwise, pass null first, and then your return arguments. On the receiving end, inside the callback function, check if the first parameter is non-null. If it is non-null, then handle it as an error.</p>
</blockquote>
</section>
<section class="slide level3">

<h4 id="définition-classique-en-node.js-avec-callbacks">Définition classique en Node.js avec callbacks</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">callback</span>(error<span class="op">,</span> retval) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (error) {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// traiter error, avec un throw par exemple</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span> <span class="co">// arrête le flot</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(retval)<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// traiter retval</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="fu">asyncfunction</span>(params<span class="op">,</span> callback)<span class="op">;</span></span></code></pre></div>
</section>
<section class="slide level3">

</section></section>
<section>
<section id="exemple-de-fonctions-asynchrones-node.js" class="title-slide slide level2">
<h2>Exemple de fonctions asynchrones : Node.js</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mypath <span class="op">=</span> <span class="st">&quot;async-node-fs-readfile.js&quot;</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Lancement lecture asynchrone file...&quot;</span>)<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>fs<span class="op">.</span><span class="fu">readFile</span>(mypath<span class="op">,</span> <span class="st">&quot;utf8&quot;</span><span class="op">,</span> <span class="kw">function</span> (err<span class="op">,</span> data) {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (err) {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(err)<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;&gt;&gt;&gt;&quot;</span>)<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(data)<span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;&lt;&lt;&lt;&quot;</span>)<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;...lecture lancée&quot;</span>)<span class="op">;</span></span></code></pre></div>
<p>Voir <a href="CM2_exemples/async-node-fs-readfile.js">exemple</a></p>
</section>
<section class="slide level3">

</section></section>
<section id="exercice-avec-settimeout" class="title-slide slide level2">
<h2>Exercice avec <code>setTimeout</code></h2>
<ol type="1">
<li>Reprendre <a href="CM2_exemples/handler-button.html">l’exemple</a> pour que quand on clique sur le bouton, le texte <code>done</code> soit ajouté à <code>output1</code> au bout du nombre de secondes saisi dans <code>input1</code></li>
<li>Ajouter un nouveau bouton qui déclenchera <em>n</em> alarmes se déclenchant au bout de 1, 2, … <em>n</em> secondes pour afficher un décompte <em>n</em>, …, 2, 1, <code>Done!</code> dans <code>output1</code>.</li>
<li>Même chose que 2. mais en utilisant <a href="https://developer.mozilla.org/en-US/docs/Web/API/setInterval"><code>setInterval</code></a></li>
<li>Même chose que 2. mais en utilisant <strong>uniquement</strong> des alarmes de 1s. La première déclenche la seconde, qui déclenche la suivante etc.</li>
</ol>
</section>
    </div>
  </div>

  <script src="https://unpkg.com/reveal.js@^4/dist/reveal.js"></script>

  <!-- reveal.js plugins -->
  <script src="https://unpkg.com/reveal.js@^4/plugin/notes/notes.js"></script>
  <script src="https://unpkg.com/reveal.js@^4/plugin/search/search.js"></script>
  <script src="https://unpkg.com/reveal.js@^4/plugin/zoom/zoom.js"></script>
  <script src="https://unpkg.com/reveal.js@^4/plugin/math/math.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({

        // Display a presentation progress bar
        progress: true,
        // Display the page number of the current slide
        slideNumber: true,
        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,
        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1280,
        height: 960,
        // Factor of the display size that should remain empty around the content
        margin: 0.02,
        // Bounds for smallest/largest possible scale to apply to content
        minScale: 0.5,
        maxScale: 1.0,
        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [
          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    </body>
</html>
